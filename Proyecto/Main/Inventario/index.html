<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inventrack - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <div class="form-content">
            <h1 id="title">Login</h1>

            <form id="formulario">
                <div class="input-group">
                    <div class="input-field" id="nameRow" style="max-height:0; overflow:hidden;">
                        <i class="fa-solid fa-user"></i>
                        <input type="text" id="nombre" placeholder="Nombre (solo registro)">
                    </div>

                    <div class="input-field">
                        <i class="fa-solid fa-envelope"></i>
                        <input type="text" id="correo" placeholder="Correo o usuario">
                    </div>

                    <div class="input-field">
                        <i class="fa-solid fa-lock"></i>
                        <input type="password" id="password" placeholder="Contraseña">
                    </div>

                    <div class="input-field" id="roleRow" style="max-height:0; overflow:hidden;">
                        <i class="fa-solid fa-shield-halved"></i>
                        <select id="rol">
                            <option value="operador">Operador</option>
                            <option value="visor">Visor</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>

                    <p>¿Olvidaste tu contraseña? <a href="#">Recupérala aquí</a></p>
                </div>

                <div class="btn-field">
                    <button id="btnSubmit" type="submit">Ingresar</button>
                    <button id="btnToggle" type="button" class="disable">Ir a Registro</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const LS_KEY = "inventrackDB";

        function loadDB() {
            const raw = localStorage.getItem(LS_KEY);
            if (raw) {
                try { return JSON.parse(raw); } catch { }
            }
            const seed = {
                products: [],
                warehouses: [],
                movements: [],
                users: [
                    {
                        id: "usr" + Date.now(),
                        name: "Administrador",
                        username: "admin@local",
                        email: "admin@local",
                        password: "123456",
                        role: "admin"
                    }
                ],
            };
            localStorage.setItem(LS_KEY, JSON.stringify(seed));
            return seed;
        }

        function saveDB() {
            localStorage.setItem(LS_KEY, JSON.stringify(db));
        }

        let db = loadDB();

        let mode = "login";
        const title = document.getElementById("title");
        const btnSubmit = document.getElementById("btnSubmit");
        const btnToggle = document.getElementById("btnToggle");
        const nameRow = document.getElementById("nameRow");
        const roleRow = document.getElementById("roleRow");

        function setMode(newMode) {
            mode = newMode;
            if (mode === "login") {
                title.textContent = "Login";
                btnSubmit.textContent = "Ingresar";
                btnToggle.textContent = "Ir a Registro";
                nameRow.style.maxHeight = "0";
                roleRow.style.maxHeight = "0";
            } else {
                title.textContent = "Registro";
                btnSubmit.textContent = "Registrar";
                btnToggle.textContent = "Ir a Login";
                nameRow.style.maxHeight = "60px";
                roleRow.style.maxHeight = "60px";
            }
        }

        btnToggle.addEventListener("click", () => {
            setMode(mode === "login" ? "register" : "login");
        });

        setMode("login");

        function setSession(user) {
            sessionStorage.setItem("inventrackUser", JSON.stringify({
                id: user.id,
                name: user.name || "",
                username: user.username || user.email,
                role: user.role
            }));
        }

        function findUserByLogin(loginText, password) {
            return db.users.find(u =>
                (u.email?.toLowerCase() === loginText.toLowerCase() ||
                    u.username?.toLowerCase() === loginText.toLowerCase())
                && u.password === password
            );
        }

        function userExists(usernameOrEmail) {
            const v = (usernameOrEmail || "").toLowerCase();
            return db.users.some(x =>
                x.username?.toLowerCase() === v || x.email?.toLowerCase() === v
            );
        }

        const form = document.getElementById("formulario");
        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const nombre = document.getElementById("nombre").value.trim();
            const correo = document.getElementById("correo").value.trim();
            const password = document.getElementById("password").value.trim();
            const rol = document.getElementById("rol").value;

            if (mode === "login") {
                if (!correo || !password) return alert("Ingresa tu correo/usuario y contraseña.");
                const user = findUserByLogin(correo, password);
                if (!user) return alert("Credenciales inválidas.");
                setSession(user);
                alert("Bienvenido " + (user.name || user.username || user.email) + " ✅");
                window.location.href = "Pages/dashboard.html";
                return;
            }

            const errors = [];
            if (!nombre) errors.push("El nombre es obligatorio.");
            if (!correo) errors.push("El correo es obligatorio.");
            const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(correo);
            if (!isEmail) errors.push("Debes ingresar un correo válido (con @).");
            if (password.length < 6) errors.push("La contraseña debe tener al menos 6 caracteres.");
            if (errors.length) return alert(errors.join("\n"));

            if (userExists(correo)) return alert("Ya existe un usuario con ese correo.");

            const newUser = {
                id: "usr" + Date.now(),
                name: nombre,
                username: correo,
                email: correo,
                password,
                role: rol
            };

            db.users.push(newUser);
            saveDB();

            alert("Registro exitoso ✅ Ahora inicia sesión con tu correo y contraseña.");
            document.getElementById("correo").value = correo;
            document.getElementById("password").value = "";
            document.getElementById("nombre").value = "";
            setMode("login");
        });
    </script>
</body>

</html>