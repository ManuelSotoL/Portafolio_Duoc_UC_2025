<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bodegas - Inventrack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v=4) }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.ico') }}">
</head>

<body onload="initWarehouses()">
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="{{ url_for('dashboard') }}">
                <img src="{{ url_for('static', filename='img/logo.png') }}" width="60" alt="Inventrack" class="me-2" />
                <span class="text-dark">Inventrack</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/pagina_principal">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">Panel</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('productos') }}">Productos</a></li>
                    <li class="nav-item"><a class="nav-link active" href="{{ url_for('bodegas') }}">Bodegas</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('movimientos') }}">Movimientos</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('reportes') }}">Reportes</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('usuarios') }}">Usuarios</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarUser"
                            role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> {{ usuario }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarUser">
                            <li>
                                <a class="dropdown-item" href="/mi_perfil">
                                    <i class="fas fa-user"></i> Mi Perfil
                                </a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
                                    <i class="fas fa-sign-out-alt"></i> Salir
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-dashboard">
        <h2 class="section-title text-center">Gesti√≥n de Bodegas</h2>

        <div class="row align-items-start g-4">
            <div class="col-12 col-lg-6">
                <div class="card w-100 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Bodegas</span>
                        <span class="badge text-bg-primary">Total: <span id="totalWarehousesCount">0</span></span>
                    </div>
                    <div class="card-body">
                        <div id="addWarehouseContainer" class="mb-3"></div>
                        <hr class="my-3">
                        <div>
                            <h6 class="mb-2">Bodegas registradas</h6>
                            <div class="scroll-list">
                                <div id="warehousesList" class="list-group"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card w-100 shadow-sm">
                    <div class="card-header text-center"><strong>Agregar Productos a Bodega</strong></div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap align-items-center toolbar mb-3">
                            <select id="selWarehouse" class="form-select form-select-sm w-auto"
                                onchange="renderProductStocksTable()"></select>
                            <input id="filterProducts" type="text" class="form-control form-control-sm w-auto"
                                placeholder="Filtrar productos..." oninput="renderProductStocksTable()">
                        </div>
                        <div id="assignSection" class="scroll-table"></div>
                    </div>
                    <div class="card-footer text-end">
                        <button id="btnSaveStocks" class="btn btn-primary btn-sm"
                            onclick="saveStocksForWarehouse()">Guardar cambios</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const IS_AUTH = JSON.parse('{{ (session.get("usuario") is not none) | tojson | safe }}');
        function requireSession() {
            if (!IS_AUTH) {
                window.location.href = "{{ url_for('login') }}"; // <-- corregido
                return null;
            }
            return true;
        }
        function logout() {
            try { sessionStorage.removeItem("inventrackUser"); } catch { }
            window.location.href = "{{ url_for('logout') }}";
        }

        const STORAGE_KEY = "inventrackDB";
        let db = loadDB();

        function loadDB() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                const seed = {
                    products: [],
                    warehouses: [],
                    movements: [],
                    users: [{ id: "usr1", username: "admin@local", password: "123456", role: "admin" }],
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(seed));
                return seed;
            }
            try { return JSON.parse(raw); }
            catch {
                const reset = { products: [], warehouses: [], movements: [], users: [] };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(reset));
                return reset;
            }
        }

        function saveDB() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

        function can(role) {
            try {
                const u = JSON.parse(sessionStorage.getItem("inventrackUser")) || null;
                return !!u && (u.role === "admin" || u.role === role);
            } catch { return false; }
        }

        function ensureStocksForWarehouses() {
            db.products = db.products.map(p => {
                const stocks = { ...(p.stocks || {}) };
                db.warehouses.forEach(w => { if (typeof stocks[w.id] !== "number") stocks[w.id] = 0; });
                return { ...p, stocks };
            });
            saveDB();
        }

        function initWarehouses() {
            if (!requireSession()) return;
            ensureStocksForWarehouses();
            renderAddWarehouse();
            renderWarehouses();
            renderWarehouseSelector();
            renderProductStocksTable();
            toggleAssignEditability();
        }

        function renderAddWarehouse() {
            const container = document.getElementById("addWarehouseContainer");
            container.innerHTML = "";

            if (!can("admin")) {
                container.innerHTML = '<div class="text-muted">Solo administradores pueden agregar bodegas.</div>';
                return;
            }

            container.innerHTML = `
        <div class="d-flex gap-2">
          <input type="text" id="warehouseName" class="form-control" placeholder="Nombre de bodega">
          <button class="btn btn-primary" onclick="addWarehouse()">Agregar</button>
        </div>`;
        }

        function renderWarehouses() {
            const container = document.getElementById("warehousesList");
            const totalEl = document.getElementById("totalWarehousesCount");
            container.innerHTML = "";

            const total = db.warehouses?.length || 0;
            if (totalEl) totalEl.textContent = total;

            if (!total) {
                container.innerHTML = `<div class="text-muted">No hay bodegas registradas.</div>`;
                return;
            }

            db.warehouses.forEach(w => {
                const totalSKUs = db.products.length;
                const totalEnBodega = db.products.reduce((acc, p) => acc + (p.stocks?.[w.id] || 0), 0);

                const item = document.createElement("div");
                item.className = "list-group-item d-flex justify-content-between align-items-center";
                item.innerHTML = `
          <div>
            <strong>${w.name}</strong>
            <div class="small text-muted">SKUs: ${totalSKUs} &middot; Stock total: ${totalEnBodega}</div>
          </div>
          <div>
            ${can("admin") ? `<button class="btn btn-outline-danger btn-sm" onclick="deleteWarehouse('${w.id}')">Eliminar</button>` : ""}
          </div>`;
                container.appendChild(item);
            });
        }

        function renderWarehouseSelector() {
            const sel = document.getElementById("selWarehouse");
            if (!sel) return;
            sel.innerHTML = "";

            if (!db.warehouses.length) {
                sel.disabled = true;
                sel.innerHTML = `<option value="">No hay bodegas</option>`;
                document.getElementById("assignSection").innerHTML = `<div class="text-muted">Primero crea una bodega.</div>`;
                document.getElementById("btnSaveStocks").disabled = true;
                return;
            }

            sel.disabled = false;
            db.warehouses.forEach(w => {
                const opt = document.createElement("option");
                opt.value = w.id;
                opt.textContent = w.name;
                sel.appendChild(opt);
            });

            if (!sel.value && db.warehouses[0]) sel.value = db.warehouses[0].id;
            document.getElementById("btnSaveStocks").disabled = !can("admin");
        }

        function renderProductStocksTable() {
            const container = document.getElementById("assignSection");
            const sel = document.getElementById("selWarehouse");
            const filter = (document.getElementById("filterProducts")?.value || "").toLowerCase();

            container.innerHTML = "";

            if (!db.products.length) {
                container.innerHTML = `<div class="text-muted">No hay productos registrados.</div>`;
                return;
            }
            if (!sel || !sel.value) {
                container.innerHTML = `<div class="text-muted">Selecciona una bodega para asignar stock.</div>`;
                return;
            }

            const wid = sel.value;
            ensureStocksForWarehouses();

            const filtered = db.products.filter(p =>
                (p.name || "").toLowerCase().includes(filter) ||
                (p.sku || "").toLowerCase().includes(filter)
            );

            if (!filtered.length) {
                container.innerHTML = `<div class="text-muted">Sin resultados con el filtro aplicado.</div>`;
                return;
            }

            const rows = filtered.map(p => {
                const current = Number(p.stocks?.[wid] ?? 0);
                const totalAll = Object.values(p.stocks || {}).reduce((a, b) => a + Number(b || 0), 0);
                const dis = can("admin") ? "" : "disabled";
                return `
          <tr>
            <td>${p.name || "(sin nombre)"}</td>
            <td>${p.sku || "-"}</td>
            <td class="text-end">
              <input type="number" min="0" step="1"
                     class="form-control form-control-sm text-end"
                     data-pid="${p.id}" value="${current}" ${dis}
                     onkeydown="if(event.key==='e'||event.key==='-')event.preventDefault();">
            </td>
            <td class="text-end">${totalAll}</td>
          </tr>`;
            }).join("");

            container.innerHTML = `
        <div class="scroll-table">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Producto</th>
                <th>SKU</th>
                <th class="text-end">Stock en bodega</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
        }

        function toggleAssignEditability() {
            const btn = document.getElementById("btnSaveStocks");
            if (btn) btn.disabled = !can("admin");
        }

        function saveStocksForWarehouse() {
            if (!can("admin")) { alert("No tienes permiso para editar stocks."); return; }
            const sel = document.getElementById("selWarehouse");
            if (!sel || !sel.value) { alert("Debes seleccionar una bodega."); return; }
            const wid = sel.value;

            const inputs = document.querySelectorAll('input[data-pid]');
            let changes = 0;
            inputs.forEach(inp => {
                const pid = inp.getAttribute('data-pid');
                const val = Math.max(0, parseInt(inp.value || "0", 10) || 0);
                const idx = db.products.findIndex(p => p.id === pid);
                if (idx >= 0) {
                    if (!db.products[idx].stocks) db.products[idx].stocks = {};
                    const prev = Number(db.products[idx].stocks[wid] || 0);
                    if (prev !== val) { db.products[idx].stocks[wid] = val; changes++; }
                }
            });

            saveDB();
            renderWarehouses();
            renderProductStocksTable();
            alert(changes ? "Stock actualizado correctamente." : "No hubo cambios.");
        }

        function addWarehouse() {
            if (!can("admin")) return alert("No tienes permiso para agregar bodegas");
            const nameInput = document.getElementById("warehouseName");
            const name = (nameInput?.value || "").trim();
            if (!name) return alert("Ingresa el nombre de la bodega");

            const id = "w" + Date.now();
            const newWarehouse = { id, name };

            db.products = db.products.map(p => ({ ...p, stocks: { ...(p.stocks || {}), [id]: 0 } }));
            db.warehouses.push(newWarehouse);

            saveDB();
            if (nameInput) nameInput.value = "";
            renderWarehouses();
            renderWarehouseSelector();
            renderProductStocksTable();
        }

        function deleteWarehouse(id) {
            if (!can("admin")) return alert("No tienes permiso para eliminar bodegas");
            if (!confirm("¬øEliminar bodega? (Se perder√°n existencias asociadas)")) return;

            db.warehouses = db.warehouses.filter(w => w.id !== id);
            db.products = db.products.map(p => {
                const { [id]: _, ...rest } = (p.stocks || {});
                return { ...p, stocks: rest };
            });

            saveDB();
            renderWarehouses();
            renderWarehouseSelector();
            renderProductStocksTable();
        }
    </script>
</body>

</html>